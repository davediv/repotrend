---
import Layout from "../../layouts/Layout.astro";
import DatePicker from "../../components/DatePicker.astro";
import Toolbar from "../../components/Toolbar.astro";
import ViewToggle from "../../components/ViewToggle.astro";
import SortDropdown from "../../components/SortDropdown.astro";
import RepoCardList from "../../components/RepoCardList.astro";
import ErrorFallback from "../../components/ErrorFallback.astro";
import { formatDateDisplay, isValidBrowseDate } from "../../lib/dates";
import { logError } from "../../lib/log";
import {
	getDateRepoCounts,
	getLanguageDistribution,
	getTrendingReposWithStreaks,
	type DateRepoCount,
	type LanguageDistribution,
	type TrendingRepo,
} from "../../lib/trending";
import { parseSortParam, sortDailyRepos } from "../../lib/sort";
import LanguageChart from "../../components/LanguageChart.astro";
import CalendarHeatmap from "../../components/CalendarHeatmap.astro";

export const prerender = false;

const { date } = Astro.params;

if (!date || !isValidBrowseDate(date)) {
	return Astro.rewrite("/404");
}

const displayDate = formatDateDisplay(date);
const sort = parseSortParam(Astro.url.searchParams.get("sort"));

let repos: TrendingRepo[] = [];
let languages: LanguageDistribution[] = [];
let dateCounts: DateRepoCount[] = [];
let hasError = false;
try {
	const db = Astro.locals.runtime.env.DB;
	repos = sortDailyRepos(await getTrendingReposWithStreaks(db, date), sort);
	try {
		languages = await getLanguageDistribution(db, date);
	} catch {
		// Non-fatal: page renders without language chart
	}
	try {
		dateCounts = await getDateRepoCounts(db);
	} catch {
		// Non-fatal: page renders without heatmap
	}
} catch (error) {
	hasError = true;
	logError("trending_date_ssr_error", { date })(error);
}
---

<Layout
	title={`Trending ${displayDate} â€” RepoTrend`}
	description={`GitHub trending repositories for ${displayDate}. Browse the most popular open-source projects that trended on ${displayDate}.`}
>
	<Toolbar>
		<DatePicker selectedDate={date} viewMode="daily" />
		<ViewToggle activeView="daily" currentDate={date} />
		<SortDropdown activeSort={sort} />
	</Toolbar>
	<LanguageChart languages={languages} />
	<CalendarHeatmap dateCounts={dateCounts} selectedDate={date} />
	{hasError ? <ErrorFallback /> : <RepoCardList repos={repos} />}
</Layout>
