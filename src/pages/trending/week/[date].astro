---
import Layout from "../../../layouts/Layout.astro";
import DatePicker from "../../../components/DatePicker.astro";
import Toolbar from "../../../components/Toolbar.astro";
import ViewToggle from "../../../components/ViewToggle.astro";
import SortDropdown from "../../../components/SortDropdown.astro";
import RepoCardList from "../../../components/RepoCardList.astro";
import ErrorFallback from "../../../components/ErrorFallback.astro";
import {
	formatWeekRange,
	getMondayOfWeek,
	getSundayOfWeek,
	isValidBrowseDate,
	todayUTC,
} from "../../../lib/dates";
import { logError } from "../../../lib/log";
import {
	getDateRepoCounts,
	getWeeklyLanguageDistribution,
	getWeeklyTrendingRepos,
	type DateRepoCount,
	type LanguageDistribution,
	type WeeklyTrendingRepo,
} from "../../../lib/trending";
import { parseSortParam, sortWeeklyRepos } from "../../../lib/sort";
import { paginate, parsePageParam } from "../../../lib/pagination";
import Pagination from "../../../components/Pagination.astro";
import LanguageChart from "../../../components/LanguageChart.astro";
import CalendarHeatmap from "../../../components/CalendarHeatmap.astro";

export const prerender = false;

const { date } = Astro.params;

if (!date || !isValidBrowseDate(date)) {
	return Astro.rewrite("/404");
}

const monday = getMondayOfWeek(date);

// Redirect to the canonical Monday URL if the date isn't already a Monday
if (date !== monday) {
	return Astro.redirect(`/trending/week/${monday}`, 302);
}

const weekLabel = formatWeekRange(date);
const weekEnd = getSundayOfWeek(monday);
const sort = parseSortParam(Astro.url.searchParams.get("sort"));

let allRepos: WeeklyTrendingRepo[] = [];
let languages: LanguageDistribution[] = [];
let dateCounts: DateRepoCount[] = [];
let partial = false;
let hasError = false;
try {
	const db = Astro.locals.runtime.env.DB;
	const result = await getWeeklyTrendingRepos(db, monday, weekEnd);
	allRepos = sortWeeklyRepos(result.repos, sort);
	const today = todayUTC();
	const weekNotFinished = weekEnd > today;
	partial = weekNotFinished || result.daysWithData < 7;
	try {
		languages = await getWeeklyLanguageDistribution(db, monday, weekEnd);
	} catch {
		// Non-fatal: page renders without language chart
	}
	try {
		dateCounts = await getDateRepoCounts(db);
	} catch {
		// Non-fatal: page renders without heatmap
	}
} catch (error) {
	hasError = true;
	logError("trending_week_ssr_error", { date })(error);
}

// Paginate the sorted repos
const page = parsePageParam(Astro.url.searchParams.get("page"));
const paginationInfo = paginate(allRepos.length, page);
const repos = allRepos.slice(paginationInfo.startIndex, paginationInfo.endIndex);
---

<Layout
	title={`Trending ${weekLabel} â€” RepoTrend`}
	description={`Weekly GitHub trending repositories for ${weekLabel}. Browse the most popular open-source projects from the week of ${weekLabel}.`}
>
	<Toolbar>
		<DatePicker selectedDate={date} viewMode="weekly" />
		<ViewToggle activeView="weekly" currentDate={date} />
		<SortDropdown activeSort={sort} viewMode="weekly" />
	</Toolbar>
	<LanguageChart languages={languages} />
	<CalendarHeatmap dateCounts={dateCounts} selectedDate={date} />
	{hasError ? <ErrorFallback /> : (
		<>
			<RepoCardList
				viewMode="weekly"
				repos={repos}
				weekLabel={weekLabel}
				weekStart={monday}
				partial={partial}
				rankOffset={paginationInfo.startIndex}
			/>
			<Pagination pagination={paginationInfo} />
		</>
	)}
</Layout>
