---
import Layout from "../../../layouts/Layout.astro";
import DatePicker from "../../../components/DatePicker.astro";
import Toolbar from "../../../components/Toolbar.astro";
import ViewToggle from "../../../components/ViewToggle.astro";
import RepoCardList from "../../../components/RepoCardList.astro";
import { formatWeekRange, getMondayOfWeek, isValidBrowseDate } from "../../../lib/dates";
import { getTrendingRepos, type TrendingRepo } from "../../../lib/trending";

export const prerender = false;

const { date } = Astro.params;

if (!date || !isValidBrowseDate(date)) {
	return Astro.rewrite("/404");
}

const monday = getMondayOfWeek(date);

// Redirect to the canonical Monday URL if the date isn't already a Monday
if (date !== monday) {
	return Astro.redirect(`/trending/week/${monday}`, 302);
}

const weekLabel = formatWeekRange(date);

let repos: TrendingRepo[] = [];
try {
	const db = Astro.locals.runtime.env.DB;
	repos = await getTrendingRepos(db, date);
} catch (error) {
	const message = error instanceof Error ? error.message : String(error);
	console.error(
		JSON.stringify({
			level: "error",
			event: "trending_week_ssr_error",
			timestamp: new globalThis.Date().toISOString(),
			date,
			error: message,
		}),
	);
}
---

<Layout
	title={`Trending ${weekLabel} â€” RepoTrend`}
	description={`Weekly GitHub trending repositories for ${weekLabel}. Browse the most popular open-source projects from the week of ${weekLabel}.`}
>
	<Toolbar>
		<DatePicker selectedDate={date} viewMode="weekly" />
		<ViewToggle activeView="weekly" currentDate={date} />
	</Toolbar>
	<RepoCardList viewMode="weekly" repos={repos} />
</Layout>
