---
import Layout from "../layouts/Layout.astro";
import RepoCard from "../components/RepoCard.astro";
import ErrorFallback from "../components/ErrorFallback.astro";
import { formatDateDisplay, isValidBrowseDate, todayUTC } from "../lib/dates";
import { logError } from "../lib/log";
import { getTrendingRepos, repoKey, type TrendingRepo } from "../lib/trending";

export const prerender = false;

const date1 = Astro.url.searchParams.get("date1")?.trim() ?? "";
const date2 = Astro.url.searchParams.get("date2")?.trim() ?? "";
const hasBothDates = date1 !== "" && date2 !== "";
const validDates =
	hasBothDates && isValidBrowseDate(date1) && isValidBrowseDate(date2) && date1 !== date2;

let date1Repos: TrendingRepo[] = [];
let date2Repos: TrendingRepo[] = [];
let commonKeys = new Set<string>();
let hasError = false;

if (validDates) {
	try {
		const db = Astro.locals.runtime.env.DB;
		[date1Repos, date2Repos] = await Promise.all([
			getTrendingRepos(db, date1),
			getTrendingRepos(db, date2),
		]);

		const date1Keys = new Set(date1Repos.map(repoKey));
		const date2Keys = new Set(date2Repos.map(repoKey));
		commonKeys = new Set([...date1Keys].filter((k) => date2Keys.has(k)));
	} catch (error) {
		hasError = true;
		logError("compare_ssr_error", { date1, date2 })(error);
	}
}

const commonCount = commonKeys.size;
const onlyDate1Count = date1Repos.length - commonCount;
const onlyDate2Count = date2Repos.length - commonCount;

const date1Display = validDates ? formatDateDisplay(date1) : "";
const date2Display = validDates ? formatDateDisplay(date2) : "";

const title = validDates
	? `Compare ${date1Display} vs ${date2Display} — RepoTrend`
	: "Compare Dates — RepoTrend";
const description = validDates
	? `Side-by-side comparison of GitHub trending repos on ${date1Display} and ${date2Display}.`
	: "Compare GitHub trending repositories across two different dates.";

const today = todayUTC();
const defaultDate1 = date1 || today;
const defaultDate2 = date2 || "";
---

<Layout title={title} description={description}>
	<div class="compare-page">
		<h1 class="compare-heading">Compare Trending Dates</h1>

		<div class="compare-picker-row">
			<div class="compare-picker">
				<label for="compare-date1">Date 1</label>
				<input
					type="date"
					id="compare-date1"
					value={defaultDate1}
					max={today}
					aria-label="Select first date to compare"
				/>
			</div>
			<span class="compare-vs" aria-hidden="true">vs</span>
			<div class="compare-picker">
				<label for="compare-date2">Date 2</label>
				<input
					type="date"
					id="compare-date2"
					value={defaultDate2}
					max={today}
					aria-label="Select second date to compare"
				/>
			</div>
			<button id="compare-btn" type="button" class="compare-submit">Compare</button>
		</div>

		{validDates && !hasError && (
			<div class="compare-summary" role="status">
				<span class="summary-stat">
					<span class="summary-count common-count">{commonCount}</span> in common
				</span>
				<span class="summary-stat">
					<span class="summary-count">{onlyDate1Count}</span> unique to {date1Display}
				</span>
				<span class="summary-stat">
					<span class="summary-count">{onlyDate2Count}</span> unique to {date2Display}
				</span>
			</div>
		)}

		{hasError && <ErrorFallback />}

		{validDates && !hasError && (
			<div class="compare-mobile-toggle" role="tablist" aria-label="Select date column">
				<button
					role="tab"
					aria-selected="true"
					aria-controls="compare-panel-1"
					data-column="1"
					class="toggle-tab active"
				>
					{date1Display}
				</button>
				<button
					role="tab"
					aria-selected="false"
					aria-controls="compare-panel-2"
					data-column="2"
					class="toggle-tab"
				>
					{date2Display}
				</button>
			</div>
		)}

		{validDates && !hasError && (
			<div class="compare-columns">
				<section id="compare-panel-1" role="tabpanel" class="compare-column" data-column="1" aria-label={`Trending repos for ${date1Display}`}>
					<h2 class="column-heading">{date1Display}</h2>
					{date1Repos.length > 0 ? (
						<ol class="card-list-results" aria-label={`Trending repositories for ${date1Display}`}>
							{date1Repos.map((repo, i) => (
								<li class={commonKeys.has(repoKey(repo)) ? "common-repo" : ""}>
									<RepoCard
										rank={i + 1}
										repoOwner={repo.repo_owner}
										repoName={repo.repo_name}
										description={repo.description}
										language={repo.language}
										languageColor={repo.language_color}
										totalStars={repo.total_stars}
										forks={repo.forks}
										starsToday={repo.stars_today}
									/>
								</li>
							))}
						</ol>
					) : (
						<div class="compare-empty" role="status">
							<p>No trending data for this date.</p>
						</div>
					)}
				</section>

				<section id="compare-panel-2" role="tabpanel" class="compare-column" data-column="2" aria-label={`Trending repos for ${date2Display}`}>
					<h2 class="column-heading">{date2Display}</h2>
					{date2Repos.length > 0 ? (
						<ol class="card-list-results" aria-label={`Trending repositories for ${date2Display}`}>
							{date2Repos.map((repo, i) => (
								<li class={commonKeys.has(repoKey(repo)) ? "common-repo" : ""}>
									<RepoCard
										rank={i + 1}
										repoOwner={repo.repo_owner}
										repoName={repo.repo_name}
										description={repo.description}
										language={repo.language}
										languageColor={repo.language_color}
										totalStars={repo.total_stars}
										forks={repo.forks}
										starsToday={repo.stars_today}
									/>
								</li>
							))}
						</ol>
					) : (
						<div class="compare-empty" role="status">
							<p>No trending data for this date.</p>
						</div>
					)}
				</section>
			</div>
		)}

		{!validDates && !hasError && hasBothDates && (
			<ErrorFallback
				icon="info"
				heading="Invalid selection"
				message="Please select two different valid dates to compare."
				showRetry={false}
			/>
		)}

		{!hasBothDates && !hasError && (
			<div class="compare-empty compare-empty--initial" role="status">
				<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
					<line x1="16" y1="2" x2="16" y2="6"></line>
					<line x1="8" y1="2" x2="8" y2="6"></line>
					<line x1="3" y1="10" x2="21" y2="10"></line>
				</svg>
				<p>Select two dates above to compare their trending repositories side by side.</p>
			</div>
		)}
	</div>
</Layout>

<script>
	const date1Input = document.getElementById("compare-date1") as HTMLInputElement;
	const date2Input = document.getElementById("compare-date2") as HTMLInputElement;
	const compareBtn = document.getElementById("compare-btn") as HTMLButtonElement;

	function navigateToCompare(): void {
		const d1 = date1Input.value;
		const d2 = date2Input.value;
		if (d1 && d2 && d1 !== d2) {
			window.location.href = `/compare?date1=${encodeURIComponent(d1)}&date2=${encodeURIComponent(d2)}`;
		}
	}

	compareBtn.addEventListener("click", navigateToCompare);

	date1Input.addEventListener("keydown", (e) => {
		if (e.key === "Enter") navigateToCompare();
	});
	date2Input.addEventListener("keydown", (e) => {
		if (e.key === "Enter") navigateToCompare();
	});

	// Mobile toggle tabs with keyboard navigation
	const tabs = document.querySelectorAll<HTMLButtonElement>(".toggle-tab");
	const columns = document.querySelectorAll<HTMLElement>(".compare-column");

	function activateTab(col: string): void {
		tabs.forEach((t) => {
			const isActive = t.dataset.column === col;
			t.classList.toggle("active", isActive);
			t.setAttribute("aria-selected", String(isActive));
		});
		columns.forEach((c) => {
			c.classList.toggle("hidden-mobile", c.dataset.column !== col);
		});
	}

	tabs.forEach((tab) => {
		tab.addEventListener("click", () => {
			if (tab.dataset.column) activateTab(tab.dataset.column);
		});
	});

	const tablist = document.querySelector<HTMLElement>(".compare-mobile-toggle");
	tablist?.addEventListener("keydown", (e) => {
		if (e.key === "ArrowLeft" || e.key === "ArrowRight") {
			e.preventDefault();
			const tabsArr = [...tabs];
			const current = tabsArr.findIndex((t) => t.getAttribute("aria-selected") === "true");
			const next =
				e.key === "ArrowRight"
					? (current + 1) % tabsArr.length
					: (current - 1 + tabsArr.length) % tabsArr.length;
			if (tabsArr[next].dataset.column) activateTab(tabsArr[next].dataset.column);
			tabsArr[next].focus();
		}
	});
</script>

<style>
	.compare-page {
		max-width: 100%;
	}

	.compare-heading {
		margin: 0 0 1.25rem;
		font-size: 1.5rem;
		font-weight: 600;
		color: var(--color-text);
	}

	/* Date picker row */
	.compare-picker-row {
		display: flex;
		align-items: flex-end;
		gap: 0.75rem;
		margin-bottom: 1.5rem;
		flex-wrap: wrap;
	}

	.compare-picker {
		display: flex;
		flex-direction: column;
		gap: 0.375rem;
	}

	.compare-picker label {
		font-size: 0.75rem;
		font-weight: 500;
		color: var(--color-text-secondary);
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.compare-picker input[type="date"] {
		height: 40px;
		padding: 0 0.75rem;
		border: 1px solid var(--color-border);
		border-radius: 6px;
		background: var(--color-bg);
		color: var(--color-text);
		font-family: inherit;
		font-size: 0.875rem;
		transition: border-color 0.15s;
	}

	.compare-picker input[type="date"]:hover {
		border-color: var(--color-border-hover);
	}

	.compare-picker input[type="date"]:focus-visible {
		border-color: var(--color-accent);
		box-shadow: 0 0 0 3px color-mix(in srgb, var(--color-accent) 20%, transparent);
	}

	.compare-vs {
		font-size: 0.875rem;
		font-weight: 600;
		color: var(--color-text-secondary);
		padding-bottom: 0.5rem;
	}

	.compare-submit {
		height: 40px;
		padding: 0 1.25rem;
		border: 1px solid var(--color-accent);
		border-radius: 6px;
		background: var(--color-accent);
		color: var(--color-accent-text);
		font-family: inherit;
		font-size: 0.875rem;
		font-weight: 500;
		cursor: pointer;
		transition: opacity 0.15s;
	}

	.compare-submit:hover {
		opacity: 0.9;
	}

	/* Summary stats */
	.compare-summary {
		display: flex;
		flex-wrap: wrap;
		gap: 1rem;
		margin-bottom: 1.25rem;
		padding: 0.75rem 1rem;
		border: 1px solid var(--color-border);
		border-radius: 6px;
		background: var(--color-bg-secondary);
		font-size: 0.875rem;
		color: var(--color-text-secondary);
	}

	.summary-count {
		font-weight: 600;
		color: var(--color-text);
	}

	.common-count {
		color: var(--color-common);
	}

	/* Mobile toggle */
	.compare-mobile-toggle {
		display: none;
	}

	/* Two-column layout */
	.compare-columns {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 1.5rem;
		align-items: start;
	}

	.compare-column {
		min-width: 0;
	}

	.column-heading {
		margin: 0 0 0.75rem;
		font-size: 1.125rem;
		font-weight: 600;
		color: var(--color-text);
	}

	/* Common repo highlight */
	.compare-columns :global(.common-repo .repo-card) {
		border-color: var(--color-common-border);
		background: var(--color-common-bg);
	}

	.compare-columns :global(.common-repo .repo-card:hover) {
		border-color: var(--color-common);
	}

	/* Empty state */
	.compare-empty {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 1rem;
		padding: 3rem 1rem;
		color: var(--color-text-secondary);
		text-align: center;
	}

	.compare-empty p {
		margin: 0;
		font-size: 1rem;
	}

	/* Card list inside compare columns */
	.compare-columns :global(.card-list-results) {
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
		list-style: none;
		margin: 0;
		padding: 0;
	}

	/* Responsive — Mobile (≤ 768px) */
	@media (max-width: 768px) {
		.compare-heading {
			font-size: 1.25rem;
		}

		.compare-picker-row {
			flex-direction: column;
			align-items: stretch;
			gap: 0.5rem;
		}

		.compare-picker {
			width: 100%;
		}

		.compare-picker input[type="date"] {
			width: 100%;
			min-height: 44px;
		}

		.compare-vs {
			text-align: center;
			padding-bottom: 0;
		}

		.compare-submit {
			width: 100%;
			min-height: 44px;
		}

		.compare-mobile-toggle {
			display: flex;
			gap: 0;
			margin-bottom: 1rem;
			border: 1px solid var(--color-border);
			border-radius: 6px;
			overflow: hidden;
		}

		.toggle-tab {
			flex: 1;
			padding: 0.625rem 0.5rem;
			border: none;
			background: var(--color-bg);
			color: var(--color-text-secondary);
			font-family: inherit;
			font-size: 0.8125rem;
			font-weight: 500;
			cursor: pointer;
			transition:
				background-color 0.15s,
				color 0.15s;
			min-height: 44px;
		}

		.toggle-tab + .toggle-tab {
			border-left: 1px solid var(--color-border);
		}

		.toggle-tab.active {
			background: var(--color-accent);
			color: var(--color-accent-text);
		}

		.compare-columns {
			grid-template-columns: 1fr;
			gap: 0;
		}

		.compare-column.hidden-mobile {
			display: none;
		}

		.column-heading {
			display: none;
		}

		.compare-summary {
			flex-direction: column;
			gap: 0.5rem;
			font-size: 0.8125rem;
		}
	}
</style>
