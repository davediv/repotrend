---
import Layout from "../layouts/Layout.astro";
import DatePicker from "../components/DatePicker.astro";
import Toolbar from "../components/Toolbar.astro";
import ViewToggle from "../components/ViewToggle.astro";
import SortDropdown from "../components/SortDropdown.astro";
import RepoCardList from "../components/RepoCardList.astro";
import ErrorFallback from "../components/ErrorFallback.astro";
import { todayUTC } from "../lib/dates";
import { logError } from "../lib/log";
import { getTrendingReposWithStreaks, type TrendingRepo } from "../lib/trending";
import { parseSortParam, sortDailyRepos } from "../lib/sort";

export const prerender = false;

const today = todayUTC();
let effectiveDate = today;
let repos: TrendingRepo[] = [];
let hasError = false;
const sort = parseSortParam(Astro.url.searchParams.get("sort"));

try {
	const db = Astro.locals.runtime.env.DB;
	const { results } = await db
		.prepare(
			`SELECT trending_date FROM trending_repos
			 WHERE trending_date <= ?
			 ORDER BY trending_date DESC
			 LIMIT 1`,
		)
		.bind(today)
		.all<{ trending_date: string }>();

	if (results.length > 0) {
		effectiveDate = results[0].trending_date;
	}

	repos = sortDailyRepos(await getTrendingReposWithStreaks(db, effectiveDate), sort);
} catch (error) {
	hasError = true;
	logError("homepage_ssr_error")(error);
}
---

<Layout
	title="RepoTrend â€” GitHub Trending Archive"
	description="Browse the historical archive of GitHub trending repositories, daily and weekly."
>
	<Toolbar>
		<DatePicker selectedDate={effectiveDate} viewMode="daily" />
		<ViewToggle activeView="daily" currentDate={effectiveDate} />
		<SortDropdown activeSort={sort} />
	</Toolbar>
	{hasError ? <ErrorFallback /> : <RepoCardList repos={repos} />}
</Layout>
