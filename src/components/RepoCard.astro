---
// Server-side repo card used for SSR rendering.
// Shared styles live in src/styles/repo-card.css (imported globally via Layout.astro).
import { formatNumber, sanitizeHexColor } from "../lib/format";

interface Props {
	rank: number;
	repoOwner: string;
	repoName: string;
	description: string | null;
	language: string | null;
	languageColor: string | null;
	totalStars: number;
	forks: number;
	starsToday: number;
	viewMode?: "daily" | "weekly";
	/** Number of days this repo appeared on trending this week (weekly view only). */
	appearances?: number;
	/** Consecutive-day trending streak (only shown when >= 2). */
	streak?: number;
}

const {
	rank,
	repoOwner,
	repoName,
	description,
	language,
	languageColor,
	totalStars,
	forks,
	starsToday,
	viewMode = "daily",
	appearances,
	streak,
} = Astro.props;

const repoUrl = `https://github.com/${repoOwner}/${repoName}`;
const safeColor = sanitizeHexColor(languageColor);
const headingId = `repo-heading-${rank}`;
const starsLabel = viewMode === "weekly" ? "this week" : "today";
const appearanceLabel = appearances === 1 ? "1 day" : `${appearances} days`;
const showStreak = streak != null && streak >= 2;
const streakLabel = showStreak ? (streak === 1 ? "1 day" : `${streak} days`) : "";
---

<article class="repo-card" aria-labelledby={headingId}>
	<div class="repo-rank" aria-hidden="true">{rank}</div>
	<div class="repo-content">
		<div class="repo-title-row">
			<h2 class="repo-name" id={headingId}>
				<span class="sr-only">#{rank}</span>
				<a href={repoUrl} target="_blank" rel="noopener noreferrer">
					<span class="repo-owner">{repoOwner}</span>
					<span class="repo-separator">/</span>
					<span class="repo-name-text">{repoName}</span>
					<span class="sr-only">(opens in new tab)</span>
				</a>
			</h2>
			{appearances != null && (
				<span class="appearances-badge" title={`Appeared on GitHub Trending for ${appearanceLabel} this week`}>
					<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
						<rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
						<line x1="16" y1="2" x2="16" y2="6"></line>
						<line x1="8" y1="2" x2="8" y2="6"></line>
						<line x1="3" y1="10" x2="21" y2="10"></line>
					</svg>
					<span class="sr-only">Trending for </span>
					{appearanceLabel}
				</span>
			)}
			{showStreak && (
				<span class="streak-badge" title={`Trending for ${streakLabel} consecutively on GitHub`}>
					<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none" aria-hidden="true">
						<path d="M17.66 11.2c-.23-.3-.51-.56-.77-.82-.67-.6-1.43-1.03-2.07-1.66C13.33 7.26 13 5.86 13.95 4c-1.73.46-2.96 1.76-3.74 3.23-.87 1.65-1.02 3.56-.16 5.23.22.42.48.8.8 1.13.32.29.66.55.63.95-.06.63-.59 1.11-1.1 1.37-.91.44-1.98.24-2.74-.39a4.32 4.32 0 0 1-1.2-1.86c-.75 1.22-.87 2.81-.28 4.15.76 1.72 2.46 2.87 4.28 3.08 1.95.23 4.05-.23 5.42-1.63 1.53-1.56 1.97-3.94 1.14-5.99-.19-.46-.44-.9-.75-1.28l-.39-.46Z" />
					</svg>
					<span class="sr-only">Trending for </span>
					{streakLabel}
					<span class="sr-only"> consecutively</span>
				</span>
			)}
		</div>

		{description && <p class="repo-description">{description}</p>}

		<div class="repo-meta">
			{language && (
				<span class="meta-item language">
					<span class="language-dot" aria-hidden="true" style={safeColor ? `background-color: ${safeColor}` : undefined}></span>
					{language}
				</span>
			)}

			<span class="meta-item">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
				</svg>
				<span class="sr-only">Total stars:</span>
				{formatNumber(totalStars)}
			</span>

			<span class="meta-item">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					<circle cx="12" cy="18" r="3"></circle>
					<circle cx="6" cy="6" r="3"></circle>
					<circle cx="18" cy="6" r="3"></circle>
					<path d="M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"></path>
					<path d="M12 12v3"></path>
				</svg>
				<span class="sr-only">Forks:</span>
				{formatNumber(forks)}
			</span>

			<span class="meta-item stars-today">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
					<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
				</svg>
				<span class="sr-only">Stars gained </span>
				{formatNumber(starsToday)} {starsLabel}
			</span>
		</div>
	</div>
</article>
