---
import type { DateRepoCount } from "../lib/trending";
import { getMondayOfWeek, parseDate, toDateString } from "../lib/dates";

interface Props {
	/** Repo counts per date, sorted chronologically (oldest first). */
	dateCounts: DateRepoCount[];
	/** Currently viewed date, highlighted in the heatmap. */
	selectedDate?: string;
}

const { dateCounts, selectedDate } = Astro.props;

// Nothing to render if the archive is empty
if (dateCounts.length === 0) return;

// Build date→count map for O(1) lookup
const countMap = new Map(dateCounts.map((d) => [d.date, d.count]));

// --- Build calendar grid ---

const latest = parseDate(dateCounts[dateCounts.length - 1].date);

// Expand range to full ISO weeks (Monday–Sunday)
const startDate = parseDate(getMondayOfWeek(dateCounts[0].date));
const endDate = new Date(latest);
const endDow = endDate.getDay();
if (endDow !== 0) endDate.setDate(endDate.getDate() + (7 - endDow));

interface Cell {
	date: string;
	count: number;
}

const weeks: Cell[][] = [];
const cursor = new Date(startDate);

while (cursor <= endDate) {
	const week: Cell[] = [];
	for (let d = 0; d < 7; d++) {
		const dateStr = toDateString(cursor);
		week.push({ date: dateStr, count: countMap.get(dateStr) ?? 0 });
		cursor.setDate(cursor.getDate() + 1);
	}
	weeks.push(week);
}

// --- Month labels with grid column indices ---

interface MonthLabel {
	label: string;
	col: number;
}

const monthFmt = new Intl.DateTimeFormat("en-US", { month: "short" });
const monthLabels: MonthLabel[] = [];
let prevMonth = -1;
for (let i = 0; i < weeks.length; i++) {
	const d = parseDate(weeks[i][0].date);
	const month = d.getMonth();
	if (month !== prevMonth) {
		monthLabels.push({ label: monthFmt.format(d), col: i });
		prevMonth = month;
	}
}

// --- Color intensity level (0–4) from repo count ---

function level(count: number): number {
	if (count === 0) return 0;
	if (count <= 6) return 1;
	if (count <= 12) return 2;
	if (count <= 18) return 3;
	return 4;
}

// --- Tooltip text ---

const tooltipFmt = new Intl.DateTimeFormat("en-US", {
	month: "short",
	day: "numeric",
	year: "numeric",
});

function tooltip(date: string, count: number): string {
	const formatted = tooltipFmt.format(parseDate(date));
	return count === 0
		? `No data on ${formatted}`
		: `${count} ${count === 1 ? "repo" : "repos"} on ${formatted}`;
}

const DOW_LABELS = ["Mon", "", "Wed", "", "Fri", "", ""];
const totalWeeks = weeks.length;
---

<section class="calendar-heatmap" aria-label="Archive calendar heatmap">
	<div class="heatmap-body">
		<div class="dow-labels" aria-hidden="true">
			{DOW_LABELS.map((label) => (
				<span class="dow-label">{label}</span>
			))}
		</div>
		<div class="heatmap-scroll">
			<div
				class="month-row"
				style={`grid-template-columns: repeat(${totalWeeks}, var(--cell-size))`}
			>
				{monthLabels.map(({ label, col }) => (
					<span class="month-label" style={`grid-column: ${col + 1}`}>{label}</span>
				))}
			</div>
			<div
				class="cell-grid"
				aria-label="Calendar heatmap of trending repository data by date"
			>
				{weeks.flatMap((week) =>
					week.map((cell) => {
						const lvl = level(cell.count);
						const tip = tooltip(cell.date, cell.count);
						const isSelected = cell.date === selectedDate;

						return cell.count > 0 ? (
							<a
								href={`/trending/${cell.date}`}
								class:list={["heatmap-cell", `level-${lvl}`, { selected: isSelected }]}
								title={tip}
								aria-label={tip}
								data-date={cell.date}
								tabindex="-1"
							/>
						) : (
							<span
								class:list={["heatmap-cell", "level-0"]}
								title={tip}
								data-date={cell.date}
							/>
						);
					}),
				)}
			</div>
		</div>
	</div>
	<div class="heatmap-legend" aria-hidden="true">
		<span class="legend-text">Less</span>
		<span class="legend-cell level-0" />
		<span class="legend-cell level-1" />
		<span class="legend-cell level-2" />
		<span class="legend-cell level-3" />
		<span class="legend-cell level-4" />
		<span class="legend-text">More</span>
	</div>
</section>

<script>
	class HeatmapController {
		private cells: HTMLElement[] = [];

		constructor(container: HTMLElement) {
			const grid = container.querySelector<HTMLElement>(".cell-grid");
			if (!grid) return;
			this.cells = Array.from(grid.querySelectorAll<HTMLElement>(".heatmap-cell"));

			// Make the selected cell (or first link) the tabbable entry point
			const selectedIdx = this.cells.findIndex((c) => c.classList.contains("selected"));
			const firstLinkIdx = this.cells.findIndex((c) => c.tagName === "A");
			const entryIdx = selectedIdx !== -1 ? selectedIdx : firstLinkIdx;
			if (entryIdx >= 0) {
				this.cells[entryIdx].setAttribute("tabindex", "0");
			}

			grid.addEventListener("keydown", this.onKeyDown.bind(this));
		}

		private onKeyDown(e: KeyboardEvent): void {
			const target = e.target as HTMLElement;
			const idx = this.cells.indexOf(target);
			if (idx === -1) return;

			let nextIdx: number | null = null;
			switch (e.key) {
				case "ArrowRight":
					nextIdx = idx + 7; // same day-of-week, next week (visually right)
					break;
				case "ArrowLeft":
					nextIdx = idx - 7; // same day-of-week, previous week (visually left)
					break;
				case "ArrowDown":
					nextIdx = idx + 1; // next day in week (visually down)
					break;
				case "ArrowUp":
					nextIdx = idx - 1; // previous day in week (visually up)
					break;
				default:
					return;
			}

			if (nextIdx !== null && nextIdx >= 0 && nextIdx < this.cells.length) {
				e.preventDefault();
				this.cells[idx].setAttribute("tabindex", "-1");
				this.cells[nextIdx].setAttribute("tabindex", "0");
				this.cells[nextIdx].focus();
			}
		}
	}

	document.querySelectorAll<HTMLElement>(".calendar-heatmap").forEach((el) => {
		new HeatmapController(el);
	});
</script>

<style>
	.calendar-heatmap {
		--cell-size: 11px;
		--cell-gap: 3px;
		margin-top: 1rem;
		margin-bottom: 1.5rem;
		padding: 1rem;
		border: 1px solid var(--color-border);
		border-radius: 8px;
		background-color: var(--color-bg-secondary);
	}

	.heatmap-body {
		display: flex;
		gap: 4px;
	}

	.dow-labels {
		display: grid;
		grid-template-rows: repeat(7, var(--cell-size));
		gap: var(--cell-gap);
		padding-top: 20px; /* align with cell-grid below month-row */
	}

	.dow-label {
		font-size: 10px;
		line-height: var(--cell-size);
		color: var(--color-text-secondary);
		text-align: right;
		padding-right: 4px;
	}

	.heatmap-scroll {
		overflow-x: auto;
		flex: 1;
		min-width: 0;
	}

	.month-row {
		display: grid;
		gap: 0 var(--cell-gap);
		height: 16px;
		margin-bottom: 4px;
	}

	.month-label {
		font-size: 10px;
		line-height: 16px;
		color: var(--color-text-secondary);
		white-space: nowrap;
	}

	.cell-grid {
		display: grid;
		grid-template-rows: repeat(7, var(--cell-size));
		grid-auto-flow: column;
		grid-auto-columns: var(--cell-size);
		gap: var(--cell-gap);
	}

	.heatmap-cell,
	.legend-cell {
		width: var(--cell-size);
		height: var(--cell-size);
		border-radius: 2px;
		display: block;
	}

	.level-0 {
		background-color: var(--color-heatmap-empty);
	}
	.level-1 {
		background-color: var(--color-heatmap-l1);
	}
	.level-2 {
		background-color: var(--color-heatmap-l2);
	}
	.level-3 {
		background-color: var(--color-heatmap-l3);
	}
	.level-4 {
		background-color: var(--color-heatmap-l4);
	}

	a.heatmap-cell {
		text-decoration: none;
		cursor: pointer;
	}

	a.heatmap-cell:hover {
		outline: 2px solid var(--color-text-secondary);
		outline-offset: -1px;
	}

	a.heatmap-cell:focus-visible {
		outline: 2px solid var(--color-accent);
		outline-offset: -1px;
	}

	.heatmap-cell.selected {
		outline: 2px solid var(--color-accent);
		outline-offset: -1px;
	}

	.heatmap-legend {
		display: flex;
		align-items: center;
		justify-content: flex-end;
		gap: 3px;
		margin-top: 0.5rem;
	}

	.legend-text {
		font-size: 10px;
		color: var(--color-text-secondary);
		margin: 0 2px;
	}

	.legend-cell {
		display: inline-block;
	}

	@media (max-width: 640px) {
		.calendar-heatmap {
			--cell-size: 10px;
			--cell-gap: 2px;
			padding: 0.75rem;
		}

		.dow-labels {
			display: none;
		}
	}
</style>
