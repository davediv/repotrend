---
// Server-rendered repo card list. Repos are fetched during SSR and passed as props,
// eliminating the client-side fetch that previously delayed LCP and caused CLS.
// Shared styles live in src/styles/repo-card.css (imported globally via Layout.astro).
import RepoCard from "./RepoCard.astro";
import type { TrendingRepo, WeeklyTrendingRepo } from "../lib/trending";
import { getSundayOfWeek } from "../lib/dates";

interface Props {
	viewMode?: "daily" | "weekly";
	repos: TrendingRepo[] | WeeklyTrendingRepo[];
	/** Week range label displayed as a header (weekly view only). */
	weekLabel?: string;
	/** ISO week-start date for the <time> datetime attribute (weekly view only). */
	weekStart?: string;
	/** Whether the week has fewer than 7 days of data (weekly view only). */
	partial?: boolean;
}

const { viewMode = "daily", repos, weekLabel, weekStart, partial } = Astro.props;
const isWeekly = viewMode === "weekly";
const emptyMessage = isWeekly
	? "No trending data available for this week."
	: "No trending data available for this date.";
const weekDatetime = weekStart ? `${weekStart}/${getSundayOfWeek(weekStart)}` : undefined;
---

{isWeekly && weekLabel && (
	<div class="weekly-header">
		<h2 class="week-range"><time datetime={weekDatetime}>{weekLabel}</time></h2>
		{partial && (
			<span class="partial-badge" title="Data does not span the full 7 days for this week">
				Partial week
			</span>
		)}
	</div>
)}

{repos.length > 0 ? (
	<ol class="card-list-results" aria-label={isWeekly ? "Weekly trending repositories" : "Trending repositories"}>
		{repos.map((repo, i) => (
			<li>
				<RepoCard
					rank={i + 1}
					repoOwner={repo.repo_owner}
					repoName={repo.repo_name}
					description={repo.description}
					language={repo.language}
					languageColor={repo.language_color}
					totalStars={repo.total_stars}
					forks={repo.forks}
					starsToday={isWeekly ? (repo as WeeklyTrendingRepo).total_stars_gained : (repo as TrendingRepo).stars_today}
					viewMode={viewMode}
					appearances={isWeekly ? (repo as WeeklyTrendingRepo).appearances : undefined}
					streak={!isWeekly ? (repo as TrendingRepo).streak : undefined}
					isNewEntry={!isWeekly ? (repo as TrendingRepo).is_new_entry : undefined}
					starHistory={!isWeekly ? (repo as TrendingRepo).star_history : undefined}
				/>
			</li>
		))}
	</ol>
) : (
	<div class="card-list-empty" role="status">
		<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
			<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
			<polyline points="14 2 14 8 20 8"></polyline>
			<line x1="9" y1="15" x2="15" y2="15"></line>
		</svg>
		<p>{emptyMessage}</p>
	</div>
)}

<style>
	.weekly-header {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		margin-bottom: 1rem;
	}

	.week-range {
		margin: 0;
		font-size: 1.25rem;
		font-weight: 600;
		color: var(--color-text);
	}

	.partial-badge {
		display: inline-flex;
		align-items: center;
		padding: 0.125rem 0.5rem;
		font-size: 0.75rem;
		font-weight: 500;
		color: var(--color-stars-today);
		background-color: var(--color-bg-secondary);
		border: 1px solid var(--color-border);
		border-radius: 1rem;
		white-space: nowrap;
	}

	.card-list-results {
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
		list-style: none;
		margin: 0;
		padding: 0;
	}

	/* Empty state */
	.card-list-empty {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 1rem;
		padding: 3rem 1rem;
		color: var(--color-text-secondary);
		text-align: center;
	}

	.card-list-empty p {
		margin: 0;
		font-size: 1rem;
	}

	@media (max-width: 640px) {
		.week-range {
			font-size: 1.0625rem;
		}
	}
</style>
