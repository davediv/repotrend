---
interface Props {
	date: string;
	viewMode?: "daily" | "weekly";
}

const { date, viewMode = "daily" } = Astro.props;
---

<div class="repo-card-list" data-date={date} data-view-mode={viewMode}>
	<div class="card-list-loading" aria-label="Loading trending repositories">
		{Array.from({ length: 5 }).map((_, i) => (
			<div class="skeleton-card" aria-hidden="true">
				<div class="skeleton-rank"></div>
				<div class="skeleton-content">
					<div class="skeleton-line skeleton-title"></div>
					<div class="skeleton-line skeleton-desc"></div>
					<div class="skeleton-meta">
						<div class="skeleton-line skeleton-tag"></div>
						<div class="skeleton-line skeleton-tag"></div>
						<div class="skeleton-line skeleton-tag"></div>
					</div>
				</div>
			</div>
		))}
	</div>

	<div class="card-list-empty" hidden>
		<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
			<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
			<polyline points="14 2 14 8 20 8"></polyline>
			<line x1="9" y1="15" x2="15" y2="15"></line>
		</svg>
		<p>No trending data available for this date.</p>
	</div>

	<div class="card-list-error" hidden>
		<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
			<circle cx="12" cy="12" r="10"></circle>
			<line x1="12" y1="8" x2="12" y2="12"></line>
			<line x1="12" y1="16" x2="12.01" y2="16"></line>
		</svg>
		<p>Failed to load data. Please try again.</p>
		<button type="button" class="retry-btn">Retry</button>
	</div>

	<div class="card-list-results" role="feed" aria-label="Trending repositories" hidden></div>
</div>

<script>
	// Client-rendered repo cards â€” keep markup in sync with RepoCard.astro (SSR variant).
	import { formatNumber, sanitizeHexColor } from "../lib/format";

	interface TrendingRepo {
		repo_owner: string;
		repo_name: string;
		description: string | null;
		language: string | null;
		language_color: string | null;
		total_stars: number;
		forks: number;
		stars_today: number;
	}

	function buildRepoCardHTML(repo: TrendingRepo, rank: number, viewMode: string): string {
		const repoUrl = `https://github.com/${repo.repo_owner}/${repo.repo_name}`;
		const safeColor = sanitizeHexColor(repo.language_color);
		const headingId = `repo-heading-${rank}`;
		const colorStyle = safeColor ? ` style="background-color: ${safeColor}"` : "";

		const descriptionHTML = repo.description
			? `<p class="repo-description">${escapeHTML(repo.description)}</p>`
			: "";

		const languageHTML = repo.language
			? `<span class="meta-item language"><span class="language-dot"${colorStyle}></span>${escapeHTML(repo.language)}</span>`
			: "";

		return `<article class="repo-card" aria-labelledby="${headingId}" aria-setsize="-1" aria-posinset="${rank}">
	<div class="repo-rank" aria-hidden="true">${rank}</div>
	<div class="repo-content">
		<h2 class="repo-name" id="${headingId}">
			<span class="sr-only">#${rank}</span>
			<a href="${repoUrl}" target="_blank" rel="noopener noreferrer">
				<span class="repo-owner">${escapeHTML(repo.repo_owner)}</span>
				<span class="repo-separator">/</span>
				<span class="repo-name-text">${escapeHTML(repo.repo_name)}</span>
			</a>
		</h2>
		${descriptionHTML}
		<div class="repo-meta">
			${languageHTML}
			<span class="meta-item">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
				<span class="sr-only">Total stars:</span>
				${formatNumber(repo.total_stars)}
			</span>
			<span class="meta-item">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><circle cx="18" cy="6" r="3"></circle><path d="M18 9v2c0 .6-.4 1-1 1H7c-.6 0-1-.4-1-1V9"></path><path d="M12 12v3"></path></svg>
				<span class="sr-only">Forks:</span>
				${formatNumber(repo.forks)}
			</span>
			<span class="meta-item stars-today">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
				<span class="sr-only">Stars gained </span>
				${formatNumber(repo.stars_today)} ${viewMode === "weekly" ? "this week" : "today"}
			</span>
		</div>
	</div>
</article>`;
	}

	function escapeHTML(str: string): string {
		const el = document.createElement("span");
		el.textContent = str;
		return el.innerHTML;
	}

	class RepoCardListController {
		private loadingEl: HTMLElement;
		private emptyEl: HTMLElement;
		private errorEl: HTMLElement;
		private resultsEl: HTMLElement;
		private date: string;
		private viewMode: string;

		constructor(container: HTMLElement) {
			this.date = container.dataset.date!;
			this.viewMode = container.dataset.viewMode || "daily";
			this.loadingEl = container.querySelector(".card-list-loading")!;
			this.emptyEl = container.querySelector(".card-list-empty")!;
			this.errorEl = container.querySelector(".card-list-error")!;
			this.resultsEl = container.querySelector(".card-list-results")!;

			container
				.querySelector(".retry-btn")!
				.addEventListener("click", () => this.fetchData());

			this.fetchData();
		}

		private showState(state: "loading" | "empty" | "error" | "results"): void {
			this.loadingEl.hidden = state !== "loading";
			this.emptyEl.hidden = state !== "empty";
			this.errorEl.hidden = state !== "error";
			this.resultsEl.hidden = state !== "results";
		}

		private async fetchData(): Promise<void> {
			this.showState("loading");

			try {
				const response = await fetch(`/api/trending/${this.date}`);
				if (!response.ok) {
					throw new Error(`HTTP ${response.status}`);
				}

				const repos: TrendingRepo[] = await response.json();

				if (repos.length === 0) {
					this.showState("empty");
					return;
				}

				this.resultsEl.innerHTML = repos
					.map((repo, i) => buildRepoCardHTML(repo, i + 1, this.viewMode))
					.join("\n");
				this.showState("results");
			} catch {
				this.showState("error");
			}
		}
	}

	document
		.querySelectorAll<HTMLElement>(".repo-card-list")
		.forEach((el) => new RepoCardListController(el));
</script>

<style>
	/* Card list results */
	.card-list-results {
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	}

	/* Loading skeletons */
	.card-list-loading {
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	}

	.skeleton-card {
		display: flex;
		gap: 1rem;
		padding: 1rem 1.25rem;
		border: 1px solid var(--color-border);
		border-radius: 6px;
		background: var(--color-bg);
	}

	.skeleton-rank {
		flex-shrink: 0;
		width: 2rem;
		height: 2rem;
		border-radius: 50%;
		background: var(--color-bg-secondary);
		animation: skeleton-pulse 1.5s ease-in-out infinite;
	}

	.skeleton-content {
		flex: 1;
		display: flex;
		flex-direction: column;
		gap: 0.5rem;
	}

	.skeleton-line {
		border-radius: 4px;
		background: var(--color-bg-secondary);
		animation: skeleton-pulse 1.5s ease-in-out infinite;
	}

	.skeleton-title {
		height: 1.25rem;
		width: 40%;
	}

	.skeleton-desc {
		height: 0.875rem;
		width: 70%;
	}

	.skeleton-meta {
		display: flex;
		gap: 1rem;
		margin-top: 0.125rem;
	}

	.skeleton-tag {
		height: 0.8125rem;
		width: 4rem;
	}

	@keyframes skeleton-pulse {
		0%,
		100% {
			opacity: 1;
		}
		50% {
			opacity: 0.4;
		}
	}

	/* Empty state */
	.card-list-empty {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 1rem;
		padding: 3rem 1rem;
		color: var(--color-text-secondary);
		text-align: center;
	}

	.card-list-empty p {
		margin: 0;
		font-size: 1rem;
	}

	/* Error state */
	.card-list-error {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 1rem;
		padding: 3rem 1rem;
		color: var(--color-text-secondary);
		text-align: center;
	}

	.card-list-error p {
		margin: 0;
		font-size: 1rem;
	}

	.retry-btn {
		padding: 0.5rem 1.25rem;
		border: 1px solid var(--color-border);
		border-radius: 6px;
		background: var(--color-bg);
		color: var(--color-text);
		font-family: inherit;
		font-size: 0.875rem;
		font-weight: 500;
		cursor: pointer;
		transition:
			border-color 0.15s,
			background-color 0.15s;
	}

	.retry-btn:hover {
		border-color: var(--color-text-secondary);
		background-color: var(--color-bg-secondary);
	}

	.retry-btn:focus-visible {
		outline: 2px solid var(--color-accent);
		outline-offset: 2px;
	}

	@media (max-width: 640px) {
		.skeleton-card {
			padding: 0.75rem 1rem;
			gap: 0.75rem;
		}
	}
</style>

<style is:global>
	/* Repo card styles for client-rendered cards */
	.card-list-results .repo-card {
		display: flex;
		gap: 1rem;
		padding: 1rem 1.25rem;
		border: 1px solid var(--color-border);
		border-radius: 6px;
		background: var(--color-bg);
		transition: border-color 0.15s;
	}

	.card-list-results .repo-card:hover {
		border-color: var(--color-text-secondary);
	}

	.card-list-results .repo-rank {
		flex-shrink: 0;
		display: flex;
		align-items: center;
		justify-content: center;
		width: 2rem;
		height: 2rem;
		border-radius: 50%;
		background: var(--color-bg-secondary);
		color: var(--color-text-secondary);
		font-size: 0.8125rem;
		font-weight: 600;
		font-variant-numeric: tabular-nums;
	}

	.card-list-results .repo-content {
		flex: 1;
		min-width: 0;
	}

	.card-list-results .repo-name {
		margin: 0;
		font-size: 1.125rem;
		font-weight: 600;
		line-height: 1.4;
	}

	.card-list-results .repo-name a {
		color: var(--color-link);
		text-decoration: none;
	}

	.card-list-results .repo-name a:hover {
		text-decoration: underline;
	}

	.card-list-results .repo-name a:focus-visible {
		outline: 2px solid var(--color-accent);
		outline-offset: 2px;
		border-radius: 2px;
	}

	.card-list-results .repo-owner {
		font-weight: 400;
		color: var(--color-link);
	}

	.card-list-results .repo-separator {
		color: var(--color-text-secondary);
		padding: 0 1px;
	}

	.card-list-results .repo-description {
		margin: 0.375rem 0 0;
		font-size: 0.875rem;
		color: var(--color-text-secondary);
		line-height: 1.5;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.card-list-results .repo-meta {
		display: flex;
		flex-wrap: wrap;
		align-items: center;
		gap: 1rem;
		margin-top: 0.625rem;
		font-size: 0.8125rem;
		color: var(--color-text-secondary);
	}

	.card-list-results .meta-item {
		display: inline-flex;
		align-items: center;
		gap: 0.25rem;
	}

	.card-list-results .meta-item svg {
		flex-shrink: 0;
	}

	.card-list-results .language-dot {
		display: inline-block;
		width: 12px;
		height: 12px;
		border-radius: 50%;
		background-color: var(--color-text-secondary);
	}

	.card-list-results .stars-today {
		color: var(--color-text);
		font-weight: 500;
	}

	@media (max-width: 640px) {
		.card-list-results .repo-card {
			padding: 0.75rem 1rem;
			gap: 0.75rem;
		}

		.card-list-results .repo-name {
			font-size: 1rem;
		}

		.card-list-results .repo-meta {
			gap: 0.75rem;
		}
	}
</style>
